"use strict";(self.webpackChunkcluster_factory_ce_docs=self.webpackChunkcluster_factory_ce_docs||[]).push([[520],{4067:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"getting-started/k0s-configuration","title":"3. K0s Configuration","description":"Specifying the hosts","source":"@site/docs/getting-started/03-k0s-configuration.md","sourceDirName":"getting-started","slug":"/getting-started/k0s-configuration","permalink":"/docs/getting-started/k0s-configuration","draft":false,"unlisted":false,"editUrl":"https://github.com/deepsquare-io/ClusterFactory/tree/main/web/docs/getting-started/03-k0s-configuration.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{},"sidebar":"docs","previous":{"title":"2. Setting up your repository for GitOps","permalink":"/docs/getting-started/setting-up-repository"},"next":{"title":"4. Core Apps Deployment","permalink":"/docs/getting-started/core-apps-deployment"}}');var i=t(3420),r=t(4942);const o={},c="3. K0s Configuration",l={},a=[{value:"Specifying the hosts",id:"specifying-the-hosts",level:2},{value:"Configuring the k0s architecture",id:"configuring-the-k0s-architecture",level:2},{value:"Initial Deployment",id:"initial-deployment",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"3-k0s-configuration",children:"3. K0s Configuration"})}),"\n",(0,i.jsx)(n.h2,{id:"specifying-the-hosts",children:"Specifying the hosts"}),"\n",(0,i.jsx)(n.p,{children:"Specify the nodes that will be included in the Kubernetes Cluster, which will function as the control plane for managing compute nodes."}),"\n",(0,i.jsxs)(n.p,{children:["A node designated as a ",(0,i.jsx)(n.strong,{children:"controller"})," will run the following components:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["An ",(0,i.jsx)(n.strong,{children:"etcd server"}),", which serves as the Kubernetes database."]}),"\n",(0,i.jsxs)(n.li,{children:["An ",(0,i.jsx)(n.strong,{children:"API server"}),", which serves as the entry point for ",(0,i.jsx)(n.code,{children:"kubectl"})," commands."]}),"\n",(0,i.jsxs)(n.li,{children:["A ",(0,i.jsx)(n.strong,{children:"Pod scheduler"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["A ",(0,i.jsx)(n.strong,{children:"controller-manager"}),", which acts as the central decision-making component of Kubernetes."]}),"\n",(0,i.jsxs)(n.li,{children:["A ",(0,i.jsx)(n.strong,{children:"Konnectivity-server"}),", responsible for facilitating communication between Kubernetes controller and worker nodes."]}),"\n",(0,i.jsxs)(n.li,{children:["A ",(0,i.jsx)(n.strong,{children:"k0s API"}),", which serves as the entry point for ",(0,i.jsx)(n.code,{children:"k0s"})," commands."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["A node designated as a ",(0,i.jsx)(n.strong,{children:"worker"})," will solely run the following components:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["A ",(0,i.jsx)(n.strong,{children:"kubelet"}),", which acts as an agent to communicate with the Konnectivity server"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Containerd"})," containers, which refer to Pods running on the worker node."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"It is crucial to always have an odd number of controllers (1, 3, 5, ...) to prevent the cluster from getting stuck in a deadlock."}),"\n",(0,i.jsxs)(n.p,{children:["Edit the ",(0,i.jsx)(n.code,{children:"cfctl.yaml"})," file. Start with the ",(0,i.jsx)(n.code,{children:"hosts"})," field:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="cfctl.yaml"',children:'apiVersion: cfctl.clusterfactory.io/v1beta1\nkind: Cluster\nmetadata:\n  name: k8s.example.com-cluster\nspec:\n  hosts:\n    - ssh:\n        address: 192.168.0.2\n        user: root\n        port: 22\n        keyPath: ~/.ssh/id_ed25519\n      role: controller+worker\n      noTaints: true\n      privateInterface: eno1\n      privateAddress: 192.168.0.2\n      installFlags:\n        - --debug\n        - --labels="topology.kubernetes.io/region=ch-sion,topology.kubernetes.io/zone=ch-sion-1"\n        - --disable-components coredns\n      hooks:\n        apply:\n          before:\n            # Set SELinux Permissive\n            - sh -c \'if [ "$(getenforce)" != "Permissive" ] && [ "$(getenforce)" != "Disabled" ]; then sed -i s/^SELINUX=.*$/SELINUX=permissive/ /etc/selinux/config; fi\'\n            - sh -c \'if [ "$(getenforce)" != "Permissive" ] && [ "$(getenforce)" != "Disabled" ]; then setenforce 0; fi\'\n\n  ...\n'})}),"\n",(0,i.jsx)(n.p,{children:"Provide each host with a valid IP address that is reachable by k0ctl, and the connection details for an SSH connection. Edit the labels for multi-zone usage."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsxs)(n.a,{href:"/docs/reference/cfctl.yaml",children:["See ",(0,i.jsx)(n.code,{children:"cfctl.yaml"})," specification"]}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"configuring-the-k0s-architecture",children:"Configuring the k0s architecture"}),"\n",(0,i.jsxs)(n.p,{children:["After you set the ",(0,i.jsx)(n.code,{children:"hosts"})," field, you must configure the k0s architecture by editing the ",(0,i.jsx)(n.code,{children:"k0s"})," field:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="cfctl.yaml > spec > k0s"',children:"k0s:\n  version: '1.28.3+k0s.0'\n  dynamicConfig: false\n  config:\n    apiVersion: k0s.k0sproject.io/v1beta1\n    kind: ClusterConfig\n    metadata:\n      name: k8s.example.com\n    spec:\n      api:\n        k0sApiPort: 9443\n        port: 6443\n      installConfig:\n        users:\n          etcdUser: etcd\n          kineUser: kube-apiserver\n          konnectivityUser: konnectivity-server\n          kubeAPIserverUser: kube-apiserver\n          kubeSchedulerUser: kube-scheduler\n      konnectivity:\n        adminPort: 8133\n        agentPort: 8132\n      network:\n        calico:\n          mode: 'vxlan'\n          overlay: Always\n          mtu: 0\n          wireguard: false\n        kubeProxy:\n          disabled: false\n          mode: iptables\n        kuberouter:\n          autoMTU: true\n          mtu: 0\n          peerRouterASNs: ''\n          peerRouterIPs: ''\n        podCIDR: 10.244.0.0/16\n        provider: calico\n        serviceCIDR: 10.96.0.0/12\n      podSecurityPolicy:\n        defaultPolicy: 00-k0s-privileged\n      storage:\n        type: etcd\n      telemetry:\n        enabled: false\n"})}),"\n",(0,i.jsx)(n.p,{children:"Most of the values are already sane, but you should check if the CIDR doesn't conflict with any IP range of your network. It is also recommended to tune manually the MTU and match it to your switch and router values."}),"\n",(0,i.jsxs)(n.p,{children:["If you wish to use a HA setup, please follow ",(0,i.jsx)(n.a,{href:"/docs/guides/maintenance/high-availability",children:"this guide"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"initial-deployment",children:"Initial Deployment"}),"\n",(0,i.jsxs)(n.admonition,{type:"tip",children:[(0,i.jsx)(n.p,{children:"If you forgot to install the utilities, just run:"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",metastring:'title="user@local:/ClusterFactory"',children:". ./scripts/setup-env\n"})})]}),"\n",(0,i.jsx)(n.p,{children:"Deploy the cluster with:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",metastring:'title="user@local:/ClusterFactory"',children:"# Deploy the cluster\ncfctl apply --debug --config ./cfctl.yaml\n\n# Fetch the kubeconfig\ncfctl kubeconfig --config ./cfctl.yaml >./kubeconfig\nchmod 600 ./kubeconfig\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You can store the kubeconfig inside ",(0,i.jsx)(n.code,{children:"~/.kube/config"}),". Our recommendation is to set the ",(0,i.jsx)(n.code,{children:"KUBECONFIG"})," environment variable to avoid mixing the Kubernetes contexts. Just like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",metastring:'title="user@local:/ClusterFactory"',children:"cfctl kubeconfig --config ./cfctl.yaml >./kubeconfig\nchmod 600 ./kubeconfig\nexport KUBECONFIG=$(pwd)/kubeconfig\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Just make sure to verify which configuration you are using with ",(0,i.jsx)(n.code,{children:"kubectl config current-context"}),". You can add an alias to your favorite shell:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:'alias kubectx="kubectl config current-context"\n'})}),"\n",(0,i.jsx)(n.p,{children:"Congratulation, you have deployed your Kubernetes cluster! However, it's still missing a few core features:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"MetalLB advertisements, for Load Balancing"}),"\n",(0,i.jsx)(n.li,{children:"CoreDNS, which is the internal DNS for Kubernetes"}),"\n",(0,i.jsx)(n.li,{children:"KubeVirt, to deploy VM workloads"}),"\n",(0,i.jsx)(n.li,{children:"Multus CNI, to support multiple network interfaces"}),"\n",(0,i.jsx)(n.li,{children:"Sealed Secrets, secret management optimized for GitOps"}),"\n",(0,i.jsx)(n.li,{children:"Cert-manager issuers, to generate your SSL certificates and enable, for free, TLS configuration."}),"\n",(0,i.jsx)(n.li,{children:"Argo CD, to enable GitOps."}),"\n",(0,i.jsx)(n.li,{children:"Traefik, as an Ingress Controller"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},4942:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>c});var s=t(6672);const i={},r=s.createContext(i);function o(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);